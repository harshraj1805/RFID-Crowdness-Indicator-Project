<!DOCTYPE html>
<html>
<head>
    <title>Live Occupancy Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
        }

        /* Centered heading */
        h1 {
            text-align: center;
        }

        /* Progress bar container */
        #progress-container {
            width: 280px; /* Slightly wider than text */
            background-color: #ddd;
            border-radius: 10px;
            margin: 10px auto;
            height: 30px;
            position: relative;
            border: 2px solid black; /* Black border */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px;
        }

        /* Progress bar */
        #progress-bar {
            width: 0%;
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease-in-out;
        }

        /* Percentage beside progress bar */
        #progress-text {
            font-weight: bold;
            padding-left: 10px;
        }

        /* Message below the progress bar */
        #status-message {
            font-size: 18px;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h1>Number of Peoples Inside: <span id="occupancy">Loading...</span></h1>

    <!-- Progress Bar -->
    <div style="display: flex; align-items: center; justify-content: center;">
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
        <div id="progress-text">0%</div>
    </div>

    <!-- Status message below progress bar -->
    <div id="status-message">Checking crowd status...</div>

    <canvas id="entryChart"></canvas>

    <script>
        const API_URL = "https://docs.google.com/spreadsheets/d/1srmt2AA5F_QCiBLcM7lAmo9pln2nhfrW4NnI6OrtfKk/gviz/tq?tqx=out:json";
        const MAX_PEOPLE = 30; // Maximum people inside

        let chartInstance = null; // Store Chart.js instance

        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                let text = await response.text();
                let json = JSON.parse(text.substring(47, text.length - 2));

                let rows = json.table.rows;
                let totalOccupancy = 0;
                let timeIntervals = { "07:00-10:00": 0, "12:00-15:00": 0, "18:00-21:00": 0 };

                rows.forEach(row => {
                    if (!row.c[0] || !row.c[1]) return;  // Skip empty rows

                    let time = row.c[0].v;  
                    let value = parseInt(row.c[1].v); 
                    totalOccupancy += value;

                    let hours = parseInt(time.split(":")[0]); 
                    if (hours >= 7 && hours < 10) timeIntervals["07:00-10:00"] += value;
                    if (hours >= 12 && hours < 15) timeIntervals["12:00-15:00"] += value;
                    if (hours >= 18 && hours < 21) timeIntervals["18:00-21:00"] += value;
                });

                document.getElementById("occupancy").innerText = totalOccupancy;
                updateProgressBar(totalOccupancy);
                updateChart(Object.keys(timeIntervals), Object.values(timeIntervals));

            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById("occupancy").innerText = "Error Loading Data!";
            }
        }

        function updateProgressBar(occupancy) {
            let percentage = Math.min((occupancy / MAX_PEOPLE) * 100, 100); // Max 100%
            let progressBar = document.getElementById("progress-bar");
            let progressText = document.getElementById("progress-text");
            let statusMessage = document.getElementById("status-message");

            // Set bar width
            progressBar.style.width = percentage + "%";
            progressText.innerText = Math.round(percentage) + "%";

            // Change bar color and status message
            if (percentage <= 50) {
                progressBar.style.backgroundColor = "green"; 
                statusMessage.innerText = "Now you can go there, it's not much crowded!";
            } else if (percentage <= 80) {
                progressBar.style.backgroundColor = "yellow"; 
                statusMessage.innerText = "It's getting crowded, proceed with caution.";
            } else {
                progressBar.style.backgroundColor = "red"; 
                statusMessage.innerText = "Very crowded! Consider waiting.";
            }
        }

        function updateChart(labels, data) {
            console.log("Chart Labels:", labels);
            console.log("Chart Data:", data);

            const ctx = document.getElementById("entryChart").getContext("2d");

            if (chartInstance) {
                chartInstance.destroy(); // Remove old chart
            }

            chartInstance = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Total Entries",
                        data: data,
                        backgroundColor: "blue"
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: Math.max(...data) + 2
                        }
                    }
                }
            });
        }

        setInterval(fetchData, 60000);
        fetchData();
    </script>
</body>
</html>
